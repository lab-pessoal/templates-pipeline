on:
  workflow_call:
name: ECR
runs:
  using: 'composite'
  steps:
    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6

    - name: ECR (create or import)
      shell: bash
      env:
        AWS_REGION: us-east-1
        TF_VAR_app_name: ${{ github.workflow }}
      run: |
        set -euo pipefail
        echo "::group::Terraform ECR"

        cd ./iac/infra-ecr
        terraform init

        REPO="$TF_VAR_app_name"

        if terraform state show aws_ecr_repository.this >/dev/null 2>&1; then
          echo "ECR já está no state: $REPO"
        else
          if aws ecr describe-repositories --repository-names "$REPO" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "ECR existe na AWS, importando no state: $REPO"
            terraform import aws_ecr_repository.this "$REPO" || true
          else
            echo "ECR não existe na AWS, será criado no apply: $REPO"
          fi
        fi

        terraform apply -auto-approve

        echo "::endgroup::"
      working-directory: ${{ github.workspace }}